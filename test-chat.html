<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitBot AI Chat - Test Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .message-bot {
            background: #f3f4f6;
            color: #1f2937;
        }
        .tutorial-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .bounce {
            animation: bounce 0.6s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-4 py-4">
                <h1 class="text-3xl font-bold text-purple-600 flex items-center gap-2">
                    <span>üí™</span> FitBot - AI Fitness Coach (Test Mode)
                </h1>
                <p class="text-sm text-gray-600 mt-1">Testing AI Chat Integration - No Login Required</p>
            </div>
        </header>

        <!-- Main Chat Container -->
        <main class="flex-1 container mx-auto px-4 py-6 max-w-4xl">
            <div class="bg-white rounded-lg shadow-lg h-[calc(100vh-200px)] flex flex-col">
                <!-- Chat Header -->
                <div class="p-4 border-b bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-t-lg">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <span>ü§ñ</span> Chat with FitBot
                    </h2>
                    <p class="text-sm opacity-90">Ask about workouts, nutrition, or get a personalized plan</p>
                </div>

                <!-- Messages Area -->
                <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ü§ñ</div>
                        <h3 class="text-xl font-semibold mb-2">Welcome to FitBot!</h3>
                        <p class="text-gray-600 mb-4">I'm your AI fitness coach. Try these:</p>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button onclick="sendQuickMessage('I want to lose weight and build muscle')" 
                                    class="px-4 py-2 bg-purple-100 hover:bg-purple-200 rounded-full text-sm transition">
                                üí¨ I want to lose weight and build muscle
                            </button>
                            <button onclick="sendQuickMessage('Create a 5-day workout plan for me')" 
                                    class="px-4 py-2 bg-purple-100 hover:bg-purple-200 rounded-full text-sm transition">
                                üí™ Create a 5-day workout plan
                            </button>
                            <button onclick="sendQuickMessage(\"I'm a beginner, help me get started\")" 
                                    class="px-4 py-2 bg-purple-100 hover:bg-purple-200 rounded-full text-sm transition">
                                üéØ I'm a beginner, help me start
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ask about workouts, nutrition, or get a personalized plan..."
                            class="flex-1 px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onkeypress="if(event.key==='Enter') sendMessage()"
                        />
                        <button 
                            onclick="sendMessage()" 
                            class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition font-semibold">
                            Send
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Backend: <span id="backendStatus" class="font-semibold">Checking...</span>
                    </p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let chatHistory = [];
        const userId = 'test-user-' + Date.now();

        // Check backend status
        async function checkBackend() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                document.getElementById('backendStatus').textContent = '‚úÖ Connected';
                document.getElementById('backendStatus').className = 'font-semibold text-green-600';
            } catch (error) {
                document.getElementById('backendStatus').textContent = '‚ùå Not Connected - Make sure backend is running on port 8000';
                document.getElementById('backendStatus').className = 'font-semibold text-red-600';
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Clear input
            input.value = '';

            // Add user message to UI
            addMessage('user', message);

            // Show loading
            const loadingId = 'loading-' + Date.now();
            addLoadingMessage(loadingId);

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: userId,
                        chat_history: chatHistory
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();

                // Remove loading
                removeLoadingMessage(loadingId);

                // Add bot response
                addMessage('bot', data.reply, data.tutorials);

                // Update chat history
                chatHistory = data.chat_history || [];

            } catch (error) {
                removeLoadingMessage(loadingId);
                addMessage('bot', `‚ùå Error: ${error.message}. Make sure the backend is running on http://localhost:8000`);
                console.error('Chat error:', error);
            }
        }

        function addMessage(role, content, tutorials = []) {
            const messagesDiv = document.getElementById('messages');
            
            // Remove welcome message if it exists
            const welcome = messagesDiv.querySelector('.text-center.py-12');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[75%] rounded-lg p-4 ${role === 'user' ? 'message-user' : 'message-bot'}`;
            
            // Format message content
            let formattedContent = content
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br/>');
            
            bubble.innerHTML = formattedContent;

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // Add tutorials if present
            if (tutorials && tutorials.length > 0) {
                const tutorialsDiv = document.createElement('div');
                tutorialsDiv.className = 'flex justify-start mt-2';
                
                const tutorialsContent = document.createElement('div');
                tutorialsContent.className = 'max-w-[75%] space-y-2';
                
                tutorials.forEach(tutorial => {
                    const card = document.createElement('div');
                    card.className = 'tutorial-card text-white p-3 rounded-lg';
                    card.innerHTML = `
                        <p class="font-semibold mb-2">üìπ ${tutorial.exercise}</p>
                        <div class="flex flex-wrap gap-2">
                            ${tutorial.links.map((link, idx) => `
                                <a href="${link}" target="_blank" 
                                   class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm transition">
                                    Video ${idx + 1}
                                </a>
                            `).join('')}
                        </div>
                    `;
                    tutorialsContent.appendChild(card);
                });
                
                tutorialsDiv.appendChild(tutorialsContent);
                messagesDiv.appendChild(tutorialsDiv);
            }

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addLoadingMessage(id) {
            const messagesDiv = document.getElementById('messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = id;
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="message-bot rounded-lg p-4">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-purple-500 rounded-full bounce" style="animation-delay: 0ms"></div>
                        <div class="w-2 h-2 bg-purple-500 rounded-full bounce" style="animation-delay: 150ms"></div>
                        <div class="w-2 h-2 bg-purple-500 rounded-full bounce" style="animation-delay: 300ms"></div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeLoadingMessage(id) {
            const loading = document.getElementById(id);
            if (loading) loading.remove();
        }

        // Check backend on load
        checkBackend();
        setInterval(checkBackend, 10000); // Check every 10 seconds
    </script>
</body>
</html>
